name: WINDOWS_CI

on: push

defaults:
  run:
    shell: bash

jobs:
  CI:
    runs-on: windows-latest

    steps:
      - name: Install gtest
        uses: MarkusJx/googletest-installer@v1.1

      - name: Install yaml-cpp
        run: |
          git clone "https://github.com/jbeder/yaml-cpp.git"
          cd yaml-cpp
          cmake -S . -B build/ -G "Visual Studio 17 2022"
          cd build
          cmake --build . --config Release
          cd ..
          cd ..
          mkdir D:/yaml-cpp
          mkdir D:/yaml-cpp/lib
          mkdir D:/yaml-cpp/include
          cp -R yaml-cpp/include/yaml-cpp D:/yaml-cpp/include
          cp yaml-cpp/build/yaml-cppd.a D:/yaml-cpp/lib

      - name: Checkout
        uses: actions/checkout@v2

      - name: Cache Qt
        id: cache-qt
        uses: actions/cache@v2
        with:
          path: ${{ runner.workspace }}/Qt
          key: ${{ runner.os }}-QtCache

      - name: Install Qt
        uses: jurplel/install-qt-action@v2
        with:
          cached: ${{ steps.cache-qt.outputs.cache-hit }}
          host: "windows"
          target: "desktop"

      - name: Build All
        run: |
          cmake -S . -B build/
          cd build
          cmake --build .
          cd ..
      - name: Run Unit Tests
        run: |
          cd  ${GITHUB_WORKSPACE}
          cd build
          cd tests
          ./tests.exe
